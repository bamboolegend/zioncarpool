<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Carpool Calendar - Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.connected { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.loading { background: #fff3cd; color: #856404; }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        input, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .calendar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 20px;
        }

        .calendar-header {
            background: #343a40;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .calendar-day {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            min-height: 100px;
            padding: 5px;
            cursor: pointer;
        }

        .calendar-day:hover {
            background: #e9ecef;
        }

        .calendar-day.today {
            background: #007bff;
            color: white;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .driver-tag {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin: 2px 0;
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó Team Carpool Calendar</h1>
        <div id="connectionStatus" class="status loading">‚è≥ Connecting to database...</div>
    </div>

    <div class="controls">
        <button onclick="changeMonth(-1)">‚Üê Previous</button>
        <h3 id="currentMonth"></h3>
        <button onclick="changeMonth(1)">Next ‚Üí</button>
        
        <input type="text" id="driverName" placeholder="Your name" maxlength="20">
        <button onclick="setDriverName()">Set Name</button>
        
        <button onclick="testFirebase()">üß™ Test Firebase</button>
    </div>

    <div class="calendar">
        <div class="calendar-grid" id="calendar"></div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        // Your Firebase config (exactly as you have it)
        const firebaseConfig = {
            apiKey: "AIzaSyDqVFoYzI4HEAViDkodV8OnLa3YDol_EaY",
            authDomain: "team-carpool-calendar.firebaseapp.com",
            databaseURL: "https://team-carpool-calendar-default-rtdb.firebaseio.com",
            projectId: "team-carpool-calendar",
            storageBucket: "team-carpool-calendar.firebasestorage.app",
            messagingSenderId: "415611592346",
            appId: "1:415611592346:web:4851832b815f75aabd8923",
            measurementId: "G-G0XVJ7P0X0"
        };

        // Global variables
        let app, database;
        let currentDate = new Date();
        let currentDriverName = '';
        let calendarData = {};

        // Initialize Firebase
        async function initFirebase() {
            try {
                console.log('Initializing Firebase...');
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                
                updateStatus('connected', '‚úÖ Connected to database!');
                console.log('Firebase initialized successfully');
                
                setupRealtimeListener();
                renderCalendar();
                
            } catch (error) {
                console.error('Firebase error:', error);
                updateStatus('error', `‚ùå Connection failed: ${error.message}`);
            }
        }

        // Update status display
        function updateStatus(type, message) {
            const status = document.getElementById('connectionStatus');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        // Setup real-time listener
        function setupRealtimeListener() {
            const calendarRef = ref(database, 'carpool-calendar');
            onValue(calendarRef, (snapshot) => {
                console.log('Database update received');
                const data = snapshot.val();
                calendarData = data || {};
                renderCalendar();
            }, (error) => {
                console.error('Database read error:', error);
                updateStatus('error', `‚ùå Read error: ${error.message}`);
            });
        }

        // Test Firebase connection
        window.testFirebase = async function() {
            try {
                console.log('Testing Firebase...');
                const testRef = ref(database, 'test');
                await set(testRef, {
                    timestamp: new Date().toISOString(),
                    message: 'Test successful!'
                });
                
                const snapshot = await get(testRef);
                const data = snapshot.val();
                console.log('Test data:', data);
                
                updateStatus('connected', '‚úÖ Firebase test successful!');
                alert('Firebase is working! Test data written and read successfully.');
                
            } catch (error) {
                console.error('Test failed:', error);
                updateStatus('error', `‚ùå Test failed: ${error.message}`);
                alert(`Test failed: ${error.message}`);
            }
        };

        // Set driver name
        window.setDriverName = function() {
            const name = document.getElementById('driverName').value.trim();
            if (name) {
                currentDriverName = name;
                localStorage.setItem('driverName', name);
                alert(`Welcome, ${name}!`);
            }
        };

        // Change month
        window.changeMonth = function(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        };

        // Add driver to day
        window.addDriver = async function(dateKey) {
            if (!currentDriverName) {
                alert('Please set your name first!');
                return;
            }

            try {
                const dayRef = ref(database, `carpool-calendar/${dateKey}`);
                const snapshot = await get(dayRef);
                const drivers = snapshot.val() || [];
                
                if (!drivers.includes(currentDriverName)) {
                    drivers.push(currentDriverName);
                    await set(dayRef, drivers);
                    console.log(`Added ${currentDriverName} to ${dateKey}`);
                } else {
                    alert('You are already driving this day!');
                }
            } catch (error) {
                console.error('Error adding driver:', error);
                alert(`Error: ${error.message}`);
            }
        };

        // Render calendar
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthElement = document.getElementById('currentMonth');
            
            // Update month display
            monthElement.textContent = currentDate.toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric'
            });

            // Clear calendar
            calendar.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const today = new Date();

            // Add empty cells for days before first day of month
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendar.appendChild(emptyDay);
            }

            // Add days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dateKey = `${date.getFullYear()}-${String(date.getMonth()).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                // Check if it's today
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }

                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                // Add drivers
                const drivers = calendarData[dateKey] || [];
                if (Array.isArray(drivers)) {
                    drivers.forEach(driver => {
                        const driverTag = document.createElement('div');
                        driverTag.className = 'driver-tag';
                        driverTag.textContent = driver;
                        dayElement.appendChild(driverTag);
                    });
                }

                // Click handler
                dayElement.onclick = () => addDriver(dateKey);

                calendar.appendChild(dayElement);
            }
        }

        // Load saved name and initialize
        document.addEventListener('DOMContentLoaded', function() {
            const savedName = localStorage.getItem('driverName');
            if (savedName) {
                currentDriverName = savedName;
                document.getElementById('driverName').value = savedName;
            }
            
            initFirebase();
        });
    </script>
</body>
</html>